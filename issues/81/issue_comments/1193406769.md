---
author_association: OWNER
created_at: '2022-07-24T22:31:32Z'
html_url: https://github.com/r7kamura/diary/issues/81#issuecomment-1193406769
id: 1193406769
issue_url: https://api.github.com/repos/r7kamura/diary/issues/81
node_id: IC_kwDOHTcevs5HIfEx
performed_via_github_app: 
reactions:
  "+1": 0
  "-1": 0
  confused: 0
  eyes: 0
  heart: 0
  hooray: 0
  laugh: 0
  rocket: 0
  total_count: 0
  url: https://api.github.com/repos/r7kamura/diary/issues/comments/1193406769/reactions
updated_at: '2022-07-25T01:34:09Z'
url: https://api.github.com/repos/r7kamura/diary/issues/comments/1193406769
user:
  avatar_url: https://avatars.githubusercontent.com/u/111689?v=4
  events_url: https://api.github.com/users/r7kamura/events{/privacy}
  followers_url: https://api.github.com/users/r7kamura/followers
  following_url: https://api.github.com/users/r7kamura/following{/other_user}
  gists_url: https://api.github.com/users/r7kamura/gists{/gist_id}
  gravatar_id: ''
  html_url: https://github.com/r7kamura
  id: 111689
  login: r7kamura
  node_id: MDQ6VXNlcjExMTY4OQ==
  organizations_url: https://api.github.com/users/r7kamura/orgs
  received_events_url: https://api.github.com/users/r7kamura/received_events
  repos_url: https://api.github.com/users/r7kamura/repos
  site_admin: false
  starred_url: https://api.github.com/users/r7kamura/starred{/owner}{/repo}
  subscriptions_url: https://api.github.com/users/r7kamura/subscriptions
  type: User
  url: https://api.github.com/users/r7kamura

---
DocumentFormattingProviderを見てみよう。

次の二種類のリクエストに対応するProviderであるらしい。

- textDocument.Formatting
- textDocument.rangeFormatting

前者は与えられたドキュメント全体を、後者は与えられたドキュメントのうち指定された範囲のフォーマットを整えるためのものらしい。

> The document range formatting request is sent from the client to the server to format a given range in a document

language-server-rubyの実装では、ここでRuboCopやらRufoやらを利用することになる。

rxjsのObservableが利用されている。外部のプロセスとのやりとりが発生するところをこれでやりとりしているのだろうか。

「ドキュメント」という単位が何を表しているのかという話があった。これは多分「ファイル」と読み替えてもさほど影響はないように思う。language-server-rubyでは、DocumentManager.tsがdocumentsというシングルトンを提供している。ドキュメントはIDを持っているらしく、このIDでdocumentsに問い合わせると対象のドキュメントが取得できるという仕組みらしい。

vscode-languageserverというパッケージがdocumentsを管理する仕組みを提供していて、documents.listen(connection) とやると良い感じにクライアントのドキュメントの情報を管理してくれるらしい。つまり、document formattingのリクエストでわざわざソースコードをやり取りしなくても、そこではドキュメントのIDだけ含めておけば良くなるということ。

Formatting Providerは、リクエストに応じて `Promise<TextEdit[]>` を返せば良いらしい。TextEditはvscode-languageserverが提供している。TextEditというのは、テキストを変形させる命令のことだと思う (e.g. replaceとか)。

> result: [TextEdit[]](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textEdit) | null describing the modification to the document to be formatted.

BaseFormatterとRuboCopFormatterを見てみると、spawnを使って子プロセスをつくり、そこで `bundle exec rubocop -s ... -a` を実行していることがわかる。-sは標準入力経由で使うやつらしい。

```
    -s, --stdin FILE                 Pipe source from STDIN, using FILE in offense
                                     reports. This is useful for editor integration.
```

```
$ echo "1 + 2" | rubocop -s foo.rb -A
Inspecting 1 file
C

Offenses:

foo.rb:1:1: C: [Corrected] Style/FrozenStringLiteralComment: Missing frozen string literal comment.
1 + 2
^
foo.rb:2:1: C: [Corrected] Layout/EmptyLineAfterMagicComment: Add an empty line after magic comments.
1 + 2
^

1 file inspected, 2 offenses detected, 2 offenses corrected
====================
# frozen_string_literal: true

1 + 2
```

これで ====== の後ろを見れば変更後のコードが取得できる。この標準出力をもとに、``TextEdit[]` を用意する。これには[diff-match-patch](https://github.com/google/diff-match-patch)というNPMパッケージが利用されている。

選択範囲だけformatしてくれというリクエストだった場合でも、ファイル全体に対してRuboCopを利用するが、diffを見て選択範囲からの書き換えだけ適用することになっている。